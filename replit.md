# نظام جدولة الحصص المدرسية

## نظرة عامة
تطبيق ويب عربي لإدارة جداول الحصص المدرسية. يسمح للمعلمين بإنشاء جداولهم الفردية، ويولد النظام تلقائياً جداول الصفوف بناءً على مدخلات المعلمين.

## الميزات الرئيسية
- **إدارة المعلمين**: إضافة، تعديل، وحذف المعلمين (مع حذف تلقائي للحصص)
  - ترتيب المعلمين حسب ترتيب مخصص للمواد مع عناوين واضحة لكل مادة
  - المعلم الجديد يظهر تحت آخر معلم في نفس المادة
  - تجميع المعلمين في grid واحد لكل مادة (معلمو نفس المادة متجاورين)
  - معالجة ذكية للمواد الإضافية غير الموجودة في القائمة المخصصة
- **جدولة الحصص**: 7 حصص × 5 أيام (الأحد-الخميس)
- **الصفوف**: الصفوف 10-12
- **الشعب الديناميكية**: إدارة مرنة للشعب (إضافة/حذف) لكل صف على حدة
  - التحقق التلقائي من وجود الشعب قبل حفظ الجدول
  - رسائل خطأ واضحة تحدد الشعب المفقودة وتوجه المستخدم لإضافتها
- **المواد**: ترتيب مخصص للمواد (إسلامية → عربي → إنجليزي → رياضيات → كيمياء → فيزياء → أحياء → اجتماعيات → حاسوب → بدنية → فنية)
- **التحقق من التعارضات**: منع وضع حصتين لمدرسين مختلفين في نفس الوقت والصف
- **نظام التنبيه الذكي**: 
  - تنبيه فوري عند إسناد صف لمعلم آخر في نفس المادة (إذا كان لديه 2+ حصص مع نفس الصف)
  - استثناء معلمي البدنية من هذا القيد (يمكن لعدة معلمين بدنية تدريس نفس الصف)
  - يعمل على البيانات الحالية في الذاكرة (scheduleData) لاكتشاف التعارضات قبل الحفظ
- **حذف الحصص الفردية**: إمكانية حذف أي حصة من جدول المدرس مع تحديث فوري للواجهة
- **الجدول الرئيسي**: 
  - خلايا واسعة (min-w-[60px]) لعرض النص كاملاً (10/1) بدون تمرير أو اختصار
  - عمود ملاحظات في نهاية الجدول باستخدام Input (بدون أسهم تكبير عمودي)
  - بدون نص placeholder في الخلايا (فارغة تماماً حتى يدخل المستخدم البيانات)
- **تصدير Excel/PDF**: 
  - جدول معلم فردي
  - **جميع جداول المعلمين**: ملف Excel واحد بصفحة لكل معلم (مع دمج الحصص المتتالية)
  - **الجدول الرئيسي**: تصدير جميع المعلمين في جدول A3 واحد من اليمين لليسار
    - ترتيب الأعمدة: ملاحظات ← الأيام (الخميس إلى الأحد) ← عدد الحصص ← المادة ← اسم المعلم ← م
    - صفوف عناوين الأيام مدمجة مع أرقام الحصص (7-1)
    - الجدول موسط في منتصف الصفحة
    - صفحة واحدة فقط مع خطوط وأحجام محسّنة
  - جدول صف فردي
  - **جميع جداول الصفوف**: ملف Excel واحد بصفحة لكل صف (مع دمج الحصص المتتالية)
  - تصميم موحد مع عمود أيام أعرض وخطوط عربية محسّنة
  - حوار تخصيص لاختيار الخطوط والألوان
  - **دمج الحصص المتتالية**: إذا كان معلم/مادة واحد في حصتين متتاليتين بنفس اليوم، يتم دمج الخلايا
- **عرض الجداول**: مع/بدون أسماء المعلمين
- **الواجهة**: RTL كامل، ثيم داكن، رسوم متحركة سلسة، خطوط عربية متعددة
  - تصميم جدول محسّن بمسافات واضحة بين الخلايا (4px)
  - تأثيرات hover ناعمة بدون حواف غامقة
  - الصفحة الرئيسية توجّه مباشرة إلى الجدول الرئيسي

## البنية التقنية

### Backend
- **Framework**: Express.js
- **التخزين**: In-memory (MemStorage)
- **API**: RESTful endpoints لجميع عمليات CRUD
- **المنفذ**: 5000 (frontend و backend على نفس المنفذ)
- **المضيف**: 0.0.0.0

### Frontend
- **Framework**: React + TypeScript + Vite
- **Routing**: Wouter
- **State Management**: TanStack Query (v5)
- **UI Components**: Shadcn/ui + Radix UI
- **Styling**: Tailwind CSS
- **PDF**: jsPDF + jsPDF-autotable
- **Dev Server**: Vite integrated with Express

### الملفات الرئيسية
- `shared/schema.ts`: تعريفات الأنواع والثوابت وجداول Drizzle
- `server/storage.ts`: واجهة التخزين وتنفيذ MemStorage
- `server/routes.ts`: API routes
- `server/index.ts`: Express server setup
- `server/vite.ts`: Vite dev server integration
- `client/src/lib/pdfGenerator.ts`: منطق تصدير PDF
- `client/src/lib/excelGenerator.ts`: منطق تصدير Excel (يستخدم القالب الجديد)
- `client/src/lib/excelImporter.ts`: منطق استيراد Excel
- `client/src/pages/Teachers.tsx`: إدارة المعلمين (مع ترتيب حسب المادة)
- `client/src/pages/TeacherSchedule.tsx`: تعديل جدول معلم
- `client/src/pages/MasterSchedule.tsx`: الجدول الرئيسي لجميع المعلمين (مع التحقق من الشعب)
- `client/src/pages/Classes.tsx`: عرض جداول الصفوف
- `client/src/components/ScheduleGrid.tsx`: شبكة الجدول (مع مسافات محسّنة)
- `client/src/components/ScheduleCell.tsx`: خلية الجدول (مع تأثيرات hover ناعمة)
- `vite.config.ts`: إعدادات Vite مع دعم Replit proxy

## API Endpoints

### المعلمون
- `GET /api/teachers` - جميع المعلمين
- `GET /api/teachers/:id` - معلم واحد
- `POST /api/teachers` - إنشاء معلم
- `PUT /api/teachers/:id` - تحديث معلم
- `DELETE /api/teachers/:id` - حذف معلم

### الحصص
- `GET /api/schedule-slots` - جميع الحصص
- `GET /api/teachers/:id/schedule-slots` - حصص معلم
- `POST /api/teachers/:id/schedule-slots/batch` - حفظ جدول معلم كامل (مع التحقق من التعارضات)
- `GET /api/class-schedules/:grade/:section` - جدول صف محدد

### الشعب
- `GET /api/grade-sections` - جميع الشعب لجميع الصفوف
- `PUT /api/grade-sections` - تحديث شعب صف محدد

### استيراد Excel
- `POST /api/import-excel` - استيراد جدول رئيسي من ملف Excel
  - يقبل ملف Excel (multipart/form-data)
  - يدعم خيار ignoreConflicts للمتابعة رغم التعارضات
  - ينظف جميع البيانات القديمة ويستوردها من جديد
  - يكتشف التعارضات تلقائياً ويعرضها للمستخدم
  - تطبيع ذكي لأسماء المواد بإزالة التطويل والمسافات

### قوالب Excel
- `client/public/جداول_template_new.xlsx`: القالب الجديد لجداول المعلمين والصفوف
- `client/public/جدول_رئيسي_template.xlsx`: قالب الجدول الرئيسي

## معلومات مهمة
- **staleTime**: Infinity في queryClient - يتطلب invalidation يدوي دقيق للذاكرة المؤقتة
- **Cache Invalidation**: عند حفظ/حذف جدول معلم، يتم invalidate جميع جداول الصفوف التي تعتمد عليه
- **التحديثات التلقائية**: جداول الصفوف تتولد تلقائياً من جداول المعلمين
- **Cascade Delete**: عند حذف معلم، يتم حذف جميع حصصه تلقائياً من جميع الجداول
- **Conflict Detection**: API يمنع حفظ جدول يحتوي على تعارضات (حصتان في نفس الوقت والصف)
- **Section Validation**: المعلم والجدول الرئيسي يتحققان من وجود الشعب قبل الحفظ
  - رسائل الخطأ التفصيلية تظهر للمستخدم عبر error.message في toast
- **React State Management**: handleDeleteSlot ينشئ object جديد بالكامل لضمان re-render فوري
- **Teacher Sorting & Grouping**: 
  - ترتيب مخصص للمواد: إسلامية، عربي، إنجليزي، رياضيات، كيمياء، فيزياء، أحياء، اجتماعيات، حاسوب، بدنية، فنية
  - يتم تجميع المعلمين في صفحة Teachers حسب المادة في grid واحد لكل مادة
  - معالجة المواد الإضافية: أي مادة غير موجودة في القائمة المخصصة تظهر في النهاية
- **Smart Alert System**:
  - نظام التنبيه يتحقق من scheduleData (البيانات الحالية في الذاكرة) بدلاً من slots (البيانات المحفوظة)
  - يكتشف التعارضات في نفس الجلسة قبل الحفظ
  - معلمو البدنية مستثنون من قاعدة "معلم واحد لكل صف في المادة"
- **Excel Import System**:
  - استيراد الجدول الرئيسي من ملف Excel
  - قراءة البيانات من الأعمدة الصحيحة: العمود 39=اسم المدرس، العمود 38=المادة
  - تطبيع أسماء المواد: إزالة علامات التطويل (ـ) والمسافات الزائدة
  - معالجة جميع الأشكال المختلفة للمواد (مثل "الإسلاميــــة" → "إسلامية")
  - دعم تسميات المواد المختلفة (مثل "الإسلاميــــة" → "إسلامية")
  - قراءة الحصص من الأعمدة 3-37 (الخميس→الأحد، الحصص 7→1)
  - كشف التعارضات تلقائياً مع خيارين: إصلاح أو المتابعة على أي حال
  - حفظ جميع المعلمين حتى الذين بدون حصص
- **Master Schedule PDF**:
  - تخطيط RTL: الأعمدة من اليمين لليسار (ملاحظات، الأيام، عدد الحصص، المادة، الاسم، م)
  - الأيام معكوسة: الخميس إلى الأحد
  - الحصص معكوسة: 7 إلى 1
  - توسيط الجدول في الصفحة باستخدام حساب leftMargin
  - صف عناوين الأيام مدمج مع صف أرقام الحصص

## التشغيل

### بيئة التطوير
```bash
npm install  # تثبيت المكتبات
npm run dev  # تشغيل الخادم
```
الخادم يعمل على المنفذ 5000 (يشمل API و Frontend)

### بيئة الإنتاج
```bash
npm run build  # بناء المشروع
npm run start  # تشغيل النسخة المنتجة
```

### النشر (Deployment)
تم إعداد التطبيق للنشر على Replit:
- **نوع النشر**: Autoscale (للتطبيقات الثابتة stateless)
- **البناء**: `npm run build`
- **التشغيل**: `npm run start`

## إعدادات Replit المهمة
- تم تكوين Vite لقبول جميع المضيفين (allowedHosts: true) للعمل مع Replit proxy
- HMR (Hot Module Replacement) يعمل عبر منفذ 443
- الخادم يعمل على 0.0.0.0:5000
